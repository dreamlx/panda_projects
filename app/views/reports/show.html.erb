<!DOCTYPE html>
<html>
<head>
  <title><%= @report.period.number %><%= @report.user.english_name %><%= DateTime.now.to_s(:number) %></title>
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <%= csrf_meta_tags %>
</head>
<body style="padding-top: 0px">
  <div class="container">
    <div class="row">
      <div class="col-md-3 col-md-offset-9">
        <%= link_to 'approve', approve_report_path(@report), method: :post, class: 'btn btn-danger' if @report.state == 'submitted' %>
        <%= link_to 'deny', deny_report_path(@report), method: :post, class: 'btn btn-danger' if @report.state == 'submitted' %>
      </div>
    </div>
    <%  
      start_date  = @report.period.starting_date
        end_date  = @report.period.ending_date
    %>
    <%= render 'header' %>
    <br />
    <div class="row">
      <div class="col-md-8">
        <table border="1">
          <!-- header of time cost-->
          <tr>
            <td rowspan="3" style="width: 300px">
              <strong>
                (6) Client Name and<br/>Description of Work
              </strong>
            </td>
            <td colspan="17" style="height: 60px">
              <strong>
                (7) Time Distribution for Period
              </strong>
            </td>
          </tr>
          <% if end_date.to_date.day < 16 %>
            <!-- first half month-->
            <tr>
              <td></td>
              <% (1..15).each  do |n| %>
                <% if weekend(start_date.to_date + (n-1).days) %>
                  <td><%= "[#{n}]" %></td>
                <% else %>
                  <td><%= n %></td>
                <% end %>
              <% end %>
              <td></td>
            </tr>
            <tr>
              <td>ADJ</td>
              <% 16.times  do |n| %>
                <td>-</td>
              <% end %>
            </tr>
          <% else %>
            <!-- second half month -->
            <tr>
              <td></td>
              <% 15.times do %>
                <td>-</td>
              <% end %>
              <td></td>
            </tr>
            <tr>
              <td>ADJ</td>
              <% (16..31).each  do |n| %>
                <% if end_date.day < n %>
                  <td>-</td>
                <% else %>
                  <td>
                    <%= (weekend(start_date.beginning_of_month + (n - 1).days) ? "[#{n}]" : n) %>
                  </td>
                <% end %>
              <% end %>
            </tr>
          <% end %>

          <!-- body -->
          <!-- projects -->
          <% @projects.each do |project| %>
            <tr>
              <td><%= truncate(project.client.english_name, length: 20) %></td>
              <td></td>
              <% 15.times  do |col| %>
                <% personalcharge = project.personalcharges.find_by(
                                      user_id: @report.user_id, 
                                      charge_date:  (start_date + col), 
                                      period_id: @report.period_id) %>
                <td>
                  <%= personalcharge ?  personalcharge.hours : "" %>
                </td>
              <% end %>
              <td></td>
            </tr>
          <% end %>

          <!-- fill the empty project field -->
          <% (20 - @projects.count ).times do |row| %>
            <tr>
              <td><%= "-" %></td>
              <% 17.times  do |col| %>
                <td><%= "" %></td>
              <% end %>
            </tr>
          <% end %>

          <!-- additional projects -->
          <% Report.additional_items.each do |key, value| %>
            <tr>
              <td>
                <small>
                  <%= key %>
                </small>
              </td>
              <td></td>
              <% 16.times  do |col| %>
                <% personalcharge = Project.find_by_job_code(value).personalcharges.find_by(
                        user_id: @report.user_id,  
                        charge_date:  (start_date + col), 
                        period_id: @report.period_id
                        ) %>
                <td style="width: 50px">
                  <%= personalcharge ?  personalcharge.hours : "" %>
                </td>
              <% end %>
            </tr>
          <% end %>

          <!-- totol -->
          <tr>
            <td>
              <small>(12) TOTAL HOURS (Including overtime)</small>
            </td>
            <td></td>
            <% 16.times do |col| %>
              <% total_hours = Personalcharge.where(
                      charge_date: start_date + col, 
                      project_id: @projects.ids,
                      user_id: @report.user_id
                      ).sum(:hours)  + 
                    Personalcharge.where(
                      charge_date: start_date + col, 
                      project_id: @additional_projects.ids,
                      user_id: @report.user_id
                      ).sum(:hours) %>
              <td>
                <%= total_hours == 0 ? "" : total_hours %>
              </td>
            <% end %>
          </tr>

          <!-- overtime -->
          <tr>
            <td>
              <small>(13) OVERTIME</small>
            </td>
            <td></td>
            <% 16.times  do |col| %>
              <% overtime_hours = Personalcharge.where(
                      charge_date: start_date + col, 
                      project_id: @projects.ids,
                      user_id: @report.user_id).sum(:hours)  + 
                    Personalcharge.where(
                      charge_date: start_date + col, 
                      project_id: @additional_projects.ids,
                      user_id: @report.user_id
                      ).sum(:hours) 
              %>
              <td>
                <% if weekend(start_date + col.days) %>
                  <%= overtime_hours == 0 ? "" : overtime_hours %>
                <% else %>
                  <%= overtime_hours > 8 ? overtime_hours -8 : ""  %>
                <% end %>
              </td>
            <% end %>
          </tr>
        </table>
      </div>

      <!-- right side -->
      <div class="col-md-4">
        <table border="1">
          <!-- right side head -->
          <tr>
            <td rowspan="3">
              <strong>
                (8)<br/>
                Total <br/>
                Hours
              </strong>
            </td>
            <td rowspan="1" colspan="4" style="height: 60px">
              <strong>
                (9) Exp RMB
              </strong>
            </td>

            <td rowspan="3">
              (10) Job<br/>
              Number
            </td>
            <td rowspan="3">
              (11) PM Approval
            </td>
          </tr>

          <tr>
            <td rowspan="1" colspan="2">
              <small>
                Meal Allowance
              </small>
            </td>
            <td rowspan="1">
              Traveling
            </td>
            <td>
              Total
            </td rowspan="1">
          </tr>
          <tr>
            <td rowspan="1"><small>RMB20</small></td>
            <td rowspan="1"><small>RMB120</small></td>
            <td rowspan="1"><small>Expenses</small></td>
            <td rowspan="1"><small>Expenses</small></td>
          </tr>

          <!-- right side body -->
          <% @projects.each do |project| %>
            <%
              pc_hours =  project.personalcharges.find_by(
                        user_id: @report.user_id,
                        period_id: @report.period_id
                        )
              pcs_hours = project.personalcharges.where(
                      user_id: @report.user_id, 
                      period_id: @report.period_id
                      )
            %>
            <tr>
              <td>
                <%= pcs_hours.sum(:hours) == 0 ? "" : pcs_hours.sum(:hours) %>
              </td>
              <td>
                <%= pc_hours ? (pc_hours.meal_allowance == 0 ? "" : pc_hours.meal_allowance) : "" %></td>
              <td>
                <%= "" %>
              </td>
              <td>
                <%= pc_hours ? (pc_hours.travel_allowance == 0 ? "" : pc_hours.travel_allowance) : "" %>
              </td>
              <td>
                <%= (pcs_hours.sum(:meal_allowance) + pcs_hours.sum(:travel_allowance) == 0) ? "" : (pcs_hours.sum(:meal_allowance) + 
                    pcs_hours.sum(:travel_allowance)) %>
              </td>
              <td>
                <%= project.job_code %>
              </td>
              <td></td>
            </tr>
          <% end %>

          <!-- fill the empty one -->
          <% (20 - @projects.count).times do |row| %>
            <tr>
              <% 5.times do %>
                <td><%= "" %></td>
              <% end %>
              <td>
                <%= "-" %>
              </td>
              <td>
                <%= "" %>
              </td>
            </tr>
          <% end %>

          <% @additional_projects.each do |project| %>
            <% 
              pc_hours = project.personalcharges.find_by(
                      user_id: @report.user_id, 
                      period_id: @report.period_id
                      )
              pcs_hours = project.personalcharges.where(
                      user_id: @report.user_id, 
                      period_id: @report.period_id
                      ) %>
            <tr>
              <td>
                <%= pcs_hours.sum(:hours) == 0 ? "" : pcs_hours.sum(:hours) %>
              </td>
              <td>
                <%= pc_hours ? (pc_hours.meal_allowance == 0 ? "" : pc_hours.meal_allowance) : "" %>
              </td>
              <td>
                <%= "" %>
              </td>
              <td>
                <%= pc_hours ? (pc_hours.travel_allowance == 0 ? "" : pc_hours.travel_allowance) : "" %>
              </td>
              <td>
                <%= (pcs_hours.sum(:meal_allowance) + pcs_hours.sum(:travel_allowance) == 0) ? "" : (pcs_hours.sum(:meal_allowance) + pcs_hours.sum(:travel_allowance)) %>
              </td>
              <td>
                <%= project.job_code %>
              </td>
              <td></td>
            </tr>
          <% end %>

          <tr>
            <td>
              <% 
                projects_pcs = Personalcharge.where(
                              period_id: @report.period_id, 
                              project_id: @projects.ids,
                              user_id: @report.user_id)
                add_projects_pcs = Personalcharge.where(
                              period_id: @report.period_id, 
                              project_id: @additional_projects.ids,
                              user_id: @report.user_id)  %>
              <%= (projects_pcs.sum(:hours) + add_projects_pcs.sum(:hours) == 0) ? "" : projects_pcs.sum(:hours)  + add_projects_pcs.sum(:hours) %>
            </td>
            <td>
              <%= (projects_pcs.sum(:meal_allowance) + add_projects_pcs.sum(:meal_allowance) == 0 ) ? "" : (projects_pcs.sum(:meal_allowance) + add_projects_pcs.sum(:meal_allowance)) %>
            </td>
            <td></td>
            <td>
              <%= (projects_pcs.sum(:travel_allowance) + add_projects_pcs.sum(:travel_allowance) == 0) ? "" : (projects_pcs.sum(:travel_allowance) + add_projects_pcs.sum(:travel_allowance)) %>
            </td>
            <td>
              <%= (projects_pcs.sum(:meal_allowance) + 
                  add_projects_pcs.sum(:meal_allowance) + 
                  projects_pcs.sum(:travel_allowance) + 
                  add_projects_pcs.sum(:travel_allowance) == 0) ? "" : (
                  projects_pcs.sum(:meal_allowance) +  
                  add_projects_pcs.sum(:meal_allowance) +
                  projects_pcs.sum(:travel_allowance) + 
                  add_projects_pcs.sum(:travel_allowance)) %>
            </td>
            <td colspan="2">
              <small>Period time and expense</small>
            </td>
          </tr>
          <tr>
            <td>
              <% overtime_total = 0.0 %>
              <% projects_pcs.each do |personalcharge| %>
                <% if weekend(personalcharge.charge_date) %>
                  <% overtime_total += personalcharge.hours %>
                <% else %>
                  <% overtime_total += (personalcharge.hours - 8) if personalcharge.hours > 8 %>
                <% end %>
              <% end %>

              <% add_projects_pcs.each do |personalcharge| %>
                <% if weekend(personalcharge.charge_date) %>
                  <% overtime_total += personalcharge.hours %>
                <% else %>
                  <% overtime_total += (personalcharge.hours - 8) if personalcharge.hours > 8 %>
                <% end %>
              <% end %>
              <%= overtime_total == 0 ? "" : overtime_total %>
            </td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td colspan="2">
              <small>Expense balance</small>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</body>
</html>


